# خطة التكامل المتقدمة - الجزء الثاني
## إكمال دمج Video Mixer + Workflow System + التطبيق الحالي

---

## 📅 الأسبوع السابع: التكامل والاختبار (تكملة)

### 7.2 تحديث Backend APIs

**إضافة روترات جديدة:**
```python
# backend/main.py - تحديث الروترات
from routers import (
    storyboard, ad_copy, settings, prompt, 
    image, video, audio, usage, admin,
    # الروترات الجديدة
    video_mixer, workflow, projects, templates
)

# تسجيل الروترات الجديدة
app.include_router(video_mixer.router, prefix="/api/v1/video-mixer")
app.include_router(workflow.router, prefix="/api/v1/workflow")
app.include_router(projects.router, prefix="/api/v1/projects")
app.include_router(templates.router, prefix="/api/v1/templates")
```

**روتر Video Mixer:**
```python
# backend/routers/video_mixer.py
from fastapi import APIRouter, HTTPException, UploadFile, File
from services.video_mixer_service import VideoMixerService
from services.file_storage_service import FileStorageService

router = APIRouter()
video_service = VideoMixerService()
storage_service = FileStorageService()

@router.post("/create-project")
async def create_video_project(project_data: dict):
    """إنشاء مشروع فيديو جديد"""
    try:
        project = await video_service.create_video_project(project_data)
        return {"success": True, "project": project}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/generate-variation/{video_id}")
async def generate_video_variation(video_id: str, new_prompt: str):
    """إنشاء تنويع من فيديو موجود"""
    try:
        variation = await video_service.generate_variation(video_id, new_prompt)
        return {"success": True, "variation": variation}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/projects/{user_id}")
async def get_user_video_projects(user_id: str):
    """الحصول على مشاريع الفيديو للمستخدم"""
    try:
        projects = await video_service.get_user_projects(user_id)
        return {"success": True, "projects": projects}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/export/{project_id}")
async def export_video_project(project_id: str, export_settings: dict):
    """تصدير مشروع فيديو"""
    try:
        export_result = await video_service.export_project(project_id, export_settings)
        return {"success": True, "export": export_result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

**روتر Workflow:**
```python
# backend/routers/workflow.py
from fastapi import APIRouter, HTTPException, BackgroundTasks
from services.workflow_engine import WorkflowEngine
from models.workflow import WorkflowDefinition, WorkflowExecution

router = APIRouter()
workflow_engine = WorkflowEngine()

@router.post("/create")
async def create_workflow(workflow_data: WorkflowDefinition):
    """إنشاء سير عمل جديد"""
    try:
        workflow = await workflow_engine.create_workflow(workflow_data)
        return {"success": True, "workflow": workflow}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/execute/{workflow_id}")
async def execute_workflow(workflow_id: str, background_tasks: BackgroundTasks):
    """تنفيذ سير العمل"""
    try:
        # تنفيذ في الخلفية
        background_tasks.add_task(workflow_engine.execute_workflow_async, workflow_id)
        
        execution = await workflow_engine.start_execution(workflow_id)
        return {"success": True, "execution_id": execution.id}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/execution/{execution_id}")
async def get_execution_status(execution_id: str):
    """الحصول على حالة التنفيذ"""
    try:
        execution = await workflow_engine.get_execution(execution_id)
        return {"success": True, "execution": execution}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/validate")
async def validate_workflow(workflow_data: WorkflowDefinition):
    """التحقق من صحة سير العمل"""
    try:
        validation_result = await workflow_engine.validate_workflow(workflow_data)
        return {"success": True, "validation": validation_result}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 7.3 تطوير مكونات الواجهة المتقدمة

**مكون إدارة المشاريع:**
```typescript
// frontend/src/pages/ProjectManager.tsx
import React, { useState, useEffect } from 'react'
import { Project, ProjectType } from '../types/project'
import { projectService } from '../services/projectService'

const ProjectManager: React.FC = () => {
  const [projects, setProjects] = useState<Project[]>([])
  const [selectedType, setSelectedType] = useState<ProjectType | 'all'>('all')
  const [isLoading, setIsLoading] = useState(true)
  const [showCreateDialog, setShowCreateDialog] = useState(false)

  useEffect(() => {
    loadProjects()
  }, [])

  const loadProjects = async () => {
    try {
      setIsLoading(true)
      const response = await projectService.getUserProjects()
      setProjects(response.data.projects)
    } catch (error) {
      console.error('خطأ في تحميل المشاريع:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const handleCreateProject = async (projectData: Partial<Project>) => {
    try {
      const response = await projectService.createProject(projectData)
      setProjects([response.data.project, ...projects])
      setShowCreateDialog(false)
    } catch (error) {
      console.error('خطأ في إنشاء المشروع:', error)
    }
  }

  const handleDuplicateProject = async (projectId: string) => {
    try {
      const response = await projectService.duplicateProject(projectId)
      setProjects([response.data.project, ...projects])
    } catch (error) {
      console.error('خطأ في نسخ المشروع:', error)
    }
  }

  const filteredProjects = selectedType === 'all' 
    ? projects 
    : projects.filter(p => p.type === selectedType)

  return (
    <div className="project-manager">
      <div className="project-header">
        <h1 className="text-3xl font-bold text-white mb-6">إدارة المشاريع</h1>
        
        <div className="project-controls">
          <div className="project-filters">
            <button
              onClick={() => setSelectedType('all')}
              className={`filter-btn ${selectedType === 'all' ? 'active' : ''}`}
            >
              جميع المشاريع
            </button>
            <button
              onClick={() => setSelectedType('video')}
              className={`filter-btn ${selectedType === 'video' ? 'active' : ''}`}
            >
              مشاريع الفيديو
            </button>
            <button
              onClick={() => setSelectedType('workflow')}
              className={`filter-btn ${selectedType === 'workflow' ? 'active' : ''}`}
            >
              سير العمل
            </button>
            <button
              onClick={() => setSelectedType('mixed')}
              className={`filter-btn ${selectedType === 'mixed' ? 'active' : ''}`}
            >
              مشاريع مختلطة
            </button>
          </div>
          
          <button
            onClick={() => setShowCreateDialog(true)}
            className="create-project-btn"
          >
            <span className="mr-2">+</span>
            مشروع جديد
          </button>
        </div>
      </div>

      {isLoading ? (
        <div className="loading-state">
          <div className="spinner"></div>
          <p>جاري تحميل المشاريع...</p>
        </div>
      ) : (
        <div className="projects-grid">
          {filteredProjects.map(project => (
            <ProjectCard
              key={project.id}
              project={project}
              onDuplicate={() => handleDuplicateProject(project.id)}
              onEdit={() => {/* فتح محرر المشروع */}}
              onDelete={() => {/* حذف المشروع */}}
            />
          ))}
        </div>
      )}

      {showCreateDialog && (
        <CreateProjectDialog
          onCreate={handleCreateProject}
          onClose={() => setShowCreateDialog(false)}
        />
      )}
    </div>
  )
}

export default ProjectManager
```

**مكون بطاقة المشروع:**
```typescript
// frontend/src/components/ProjectCard.tsx
import React from 'react'
import { Project } from '../types/project'
import { formatDate } from '../utils/dateUtils'

interface ProjectCardProps {
  project: Project
  onEdit: () => void
  onDuplicate: () => void
  onDelete: () => void
}

const ProjectCard: React.FC<ProjectCardProps> = ({
  project,
  onEdit,
  onDuplicate,
  onDelete
}) => {
  const getProjectTypeIcon = (type: string) => {
    switch (type) {
      case 'video': return '🎬'
      case 'workflow': return '⚙️'
      case 'mixed': return '🎯'
      default: return '📁'
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'text-green-500'
      case 'in_progress': return 'text-yellow-500'
      case 'draft': return 'text-gray-500'
      case 'failed': return 'text-red-500'
      default: return 'text-gray-500'
    }
  }

  return (
    <div className="project-card">
      <div className="project-card-header">
        <div className="project-type-icon">
          {getProjectTypeIcon(project.type)}
        </div>
        <div className="project-status">
          <span className={`status-indicator ${getStatusColor(project.status)}`}>
            ●
          </span>
        </div>
      </div>

      <div className="project-card-content">
        <h3 className="project-title">{project.name}</h3>
        <p className="project-description">{project.description}</p>
        
        <div className="project-meta">
          <span className="project-date">
            {formatDate(project.updated_at)}
          </span>
          <span className="project-type-label">
            {project.type === 'video' ? 'فيديو' : 
             project.type === 'workflow' ? 'سير عمل' : 'مختلط'}
          </span>
        </div>
      </div>

      <div className="project-card-actions">
        <button onClick={onEdit} className="action-btn edit-btn">
          تحرير
        </button>
        <button onClick={onDuplicate} className="action-btn duplicate-btn">
          نسخ
        </button>
        <button onClick={onDelete} className="action-btn delete-btn">
          حذف
        </button>
      </div>
    </div>
  )
}

export default ProjectCard
```

---

## 📅 الأسبوع الثامن: التحسين والنشر

### 8.1 تحسينات الأداء

**تحسين تحميل المكونات:**
```typescript
// frontend/src/utils/lazyLoading.ts
import { lazy } from 'react'

// تحميل كسول للمكونات الثقيلة
export const VideoMixerStudio = lazy(() => import('../pages/VideoMixerStudio'))
export const WorkflowBuilder = lazy(() => import('../pages/WorkflowBuilder'))
export const ProjectManager = lazy(() => import('../pages/ProjectManager'))

// مكون التحميل
export const LoadingSpinner = () => (
  <div className="loading-container">
    <div className="spinner"></div>
    <p>جاري التحميل...</p>
  </div>
)
```

**تحسين إدارة الحالة:**
```typescript
// frontend/src/store/projectStore.ts
import { create } from 'zustand'
import { Project } from '../types/project'

interface ProjectStore {
  projects: Project[]
  activeProject: Project | null
  isLoading: boolean
  
  // Actions
  setProjects: (projects: Project[]) => void
  addProject: (project: Project) => void
  updateProject: (id: string, updates: Partial<Project>) => void
  deleteProject: (id: string) => void
  setActiveProject: (project: Project | null) => void
  setLoading: (loading: boolean) => void
}

export const useProjectStore = create<ProjectStore>((set) => ({
  projects: [],
  activeProject: null,
  isLoading: false,
  
  setProjects: (projects) => set({ projects }),
  addProject: (project) => set((state) => ({ 
    projects: [project, ...state.projects] 
  })),
  updateProject: (id, updates) => set((state) => ({
    projects: state.projects.map(p => 
      p.id === id ? { ...p, ...updates } : p
    )
  })),
  deleteProject: (id) => set((state) => ({
    projects: state.projects.filter(p => p.id !== id)
  })),
  setActiveProject: (project) => set({ activeProject: project }),
  setLoading: (loading) => set({ isLoading: loading })
}))
```

### 8.2 نظام المراقبة والتحليلات

**خدمة التحليلات:**
```python
# backend/services/analytics_service.py
import asyncio
from datetime import datetime, timedelta
from typing import Dict, List, Any
from sqlalchemy import func
from models.usage import UsageLog, ProjectUsage, WorkflowExecution

class AnalyticsService:
    def __init__(self):
        self.db = get_database_session()
    
    async def get_usage_statistics(self, days: int = 30) -> Dict[str, Any]:
        """إحصائيات الاستخدام"""
        end_date = datetime.utcnow()
        start_date = end_date - timedelta(days=days)
        
        # إحصائيات المشاريع
        project_stats = await self.db.query(
            func.count(Project.id).label('total_projects'),
            func.count(Project.id).filter(Project.status == 'completed').label('completed_projects'),
            func.count(Project.id).filter(Project.created_at >= start_date).label('recent_projects')
        ).first()
        
        # إحصائيات سير العمل
        workflow_stats = await self.db.query(
            func.count(WorkflowExecution.id).label('total_executions'),
            func.count(WorkflowExecution.id).filter(WorkflowExecution.status == 'completed').label('successful_executions'),
            func.avg(WorkflowExecution.duration_seconds).label('avg_duration')
        ).filter(WorkflowExecution.created_at >= start_date).first()
        
        # أكثر الخدمات استخداماً
        popular_services = await self.db.query(
            UsageLog.service_type,
            func.count(UsageLog.id).label('usage_count')
        ).filter(UsageLog.created_at >= start_date)\
         .group_by(UsageLog.service_type)\
         .order_by(func.count(UsageLog.id).desc())\
         .limit(10).all()
        
        return {
            'project_statistics': {
                'total_projects': project_stats.total_projects,
                'completed_projects': project_stats.completed_projects,
                'recent_projects': project_stats.recent_projects,
                'completion_rate': (project_stats.completed_projects / project_stats.total_projects * 100) if project_stats.total_projects > 0 else 0
            },
            'workflow_statistics': {
                'total_executions': workflow_stats.total_executions,
                'successful_executions': workflow_stats.successful_executions,
                'success_rate': (workflow_stats.successful_executions / workflow_stats.total_executions * 100) if workflow_stats.total_executions > 0 else 0,
                'average_duration': workflow_stats.avg_duration
            },
            'popular_services': [
                {'service': service.service_type, 'count': service.usage_count}
                for service in popular_services
            ]
        }
    
    async def get_performance_metrics(self) -> Dict[str, Any]:
        """مقاييس الأداء"""
        # متوسط أوقات الاستجابة
        response_times = await self.db.query(
            UsageLog.service_type,
            func.avg(UsageLog.response_time_ms).label('avg_response_time')
        ).group_by(UsageLog.service_type).all()
        
        # معدل الأخطاء
        error_rates = await self.db.query(
            UsageLog.service_type,
            func.count(UsageLog.id).label('total_requests'),
            func.count(UsageLog.id).filter(UsageLog.status == 'error').label('error_requests')
        ).group_by(UsageLog.service_type).all()
        
        return {
            'response_times': {
                service.service_type: service.avg_response_time
                for service in response_times
            },
            'error_rates': {
                service.service_type: (service.error_requests / service.total_requests * 100) if service.total_requests > 0 else 0
                for service in error_rates
            }
        }
```

**لوحة تحكم التحليلات:**
```typescript
// frontend/src/components/AnalyticsDashboard.tsx
import React, { useState, useEffect } from 'react'
import { analyticsService } from '../services/analyticsService'

const AnalyticsDashboard: React.FC = () => {
  const [analytics, setAnalytics] = useState<any>(null)
  const [timeRange, setTimeRange] = useState(30)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    loadAnalytics()
  }, [timeRange])

  const loadAnalytics = async () => {
    try {
      setIsLoading(true)
      const [usage, performance] = await Promise.all([
        analyticsService.getUsageStatistics(timeRange),
        analyticsService.getPerformanceMetrics()
      ])
      
      setAnalytics({ usage, performance })
    } catch (error) {
      console.error('خطأ في تحميل التحليلات:', error)
    } finally {
      setIsLoading(false)
    }
  }

  if (isLoading) {
    return <div className="loading-state">جاري تحميل التحليلات...</div>
  }

  return (
    <div className="analytics-dashboard">
      <div className="analytics-header">
        <h2 className="text-2xl font-bold text-white mb-4">تحليلات الاستخدام</h2>
        
        <div className="time-range-selector">
          <button
            onClick={() => setTimeRange(7)}
            className={`range-btn ${timeRange === 7 ? 'active' : ''}`}
          >
            7 أيام
          </button>
          <button
            onClick={() => setTimeRange(30)}
            className={`range-btn ${timeRange === 30 ? 'active' : ''}`}
          >
            30 يوم
          </button>
          <button
            onClick={() => setTimeRange(90)}
            className={`range-btn ${timeRange === 90 ? 'active' : ''}`}
          >
            90 يوم
          </button>
        </div>
      </div>

      <div className="analytics-grid">
        {/* إحصائيات المشاريع */}
        <div className="analytics-card">
          <h3 className="card-title">إحصائيات المشاريع</h3>
          <div className="stats-grid">
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.project_statistics.total_projects}</span>
              <span className="stat-label">إجمالي المشاريع</span>
            </div>
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.project_statistics.completed_projects}</span>
              <span className="stat-label">مشاريع مكتملة</span>
            </div>
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.project_statistics.completion_rate.toFixed(1)}%</span>
              <span className="stat-label">معدل الإكمال</span>
            </div>
          </div>
        </div>

        {/* إحصائيات سير العمل */}
        <div className="analytics-card">
          <h3 className="card-title">إحصائيات سير العمل</h3>
          <div className="stats-grid">
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.workflow_statistics.total_executions}</span>
              <span className="stat-label">إجمالي التنفيذات</span>
            </div>
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.workflow_statistics.success_rate.toFixed(1)}%</span>
              <span className="stat-label">معدل النجاح</span>
            </div>
            <div className="stat-item">
              <span className="stat-value">{analytics.usage.workflow_statistics.average_duration?.toFixed(1)}s</span>
              <span className="stat-label">متوسط المدة</span>
            </div>
          </div>
        </div>

        {/* الخدمات الأكثر استخداماً */}
        <div className="analytics-card">
          <h3 className="card-title">الخدمات الأكثر استخداماً</h3>
          <div className="service-list">
            {analytics.usage.popular_services.map((service: any, index: number) => (
              <div key={service.service} className="service-item">
                <span className="service-rank">#{index + 1}</span>
                <span className="service-name">{service.service}</span>
                <span className="service-count">{service.count}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}

export default AnalyticsDashboard
```

### 8.3 إعداد النشر النهائي

**Docker Compose للمنصة الموحدة:**
```yaml
# docker-compose.unified.yml
version: '3.8'

services:
  # قاعدة البيانات
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: mubdi_ai
      POSTGRES_USER: mubdi_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - mubdi_network

  # Redis للتخزين المؤقت
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mubdi_network

  # الواجهة الخلفية
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DATABASE_URL=postgresql://mubdi_user:${DB_PASSWORD}@postgres:5432/mubdi_ai
      - REDIS_URL=redis://redis:6379
      - STORAGE_PATH=/app/storage
    volumes:
      - ./storage:/app/storage
      - ./logs:/app/logs
    ports:
      - "12000:12000"
    depends_on:
      - postgres
      - redis
    networks:
      - mubdi_network

  # الواجهة الأمامية
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - REACT_APP_API_URL=http://localhost:12000
    ports:
      - "12001:80"
    depends_on:
      - backend
    networks:
      - mubdi_network

  # Nginx
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl
      - ./storage:/var/www/storage
    depends_on:
      - frontend
      - backend
    networks:
      - mubdi_network

volumes:
  postgres_data:
  redis_data:

networks:
  mubdi_network:
    driver: bridge
```

**سكريبت النشر الآلي:**
```bash
#!/bin/bash
# deploy.sh - سكريبت النشر الآلي

set -e

echo "🚀 بدء عملية النشر لمنصة مُبدع AI الموحدة..."

# التحقق من متغيرات البيئة
if [ -z "$GEMINI_API_KEY" ]; then
    echo "❌ خطأ: GEMINI_API_KEY غير محدد"
    exit 1
fi

if [ -z "$DB_PASSWORD" ]; then
    echo "❌ خطأ: DB_PASSWORD غير محدد"
    exit 1
fi

# إنشاء المجلدات المطلوبة
echo "📁 إنشاء المجلدات..."
mkdir -p storage/{projects,assets/{images,videos,audio,documents},temp,exports}
mkdir -p logs
mkdir -p nginx/ssl

# بناء الصور
echo "🔨 بناء صور Docker..."
docker-compose -f docker-compose.unified.yml build

# تشغيل قاعدة البيانات أولاً
echo "🗄️ تشغيل قاعدة البيانات..."
docker-compose -f docker-compose.unified.yml up -d postgres redis

# انتظار جاهزية قاعدة البيانات
echo "⏳ انتظار جاهزية قاعدة البيانات..."
sleep 10

# تشغيل باقي الخدمات
echo "🌐 تشغيل جميع الخدمات..."
docker-compose -f docker-compose.unified.yml up -d

# التحقق من حالة الخدمات
echo "🔍 التحقق من حالة الخدمات..."
sleep 15

# اختبار الاتصال
echo "🧪 اختبار الاتصال..."
if curl -f http://localhost:12000/health > /dev/null 2>&1; then
    echo "✅ الواجهة الخلفية تعمل بنجاح"
else
    echo "❌ خطأ في الواجهة الخلفية"
    exit 1
fi

if curl -f http://localhost:12001 > /dev/null 2>&1; then
    echo "✅ الواجهة الأمامية تعمل بنجاح"
else
    echo "❌ خطأ في الواجهة الأمامية"
    exit 1
fi

echo "🎉 تم النشر بنجاح!"
echo "🌐 الواجهة الأمامية: http://localhost:12001"
echo "🔧 API: http://localhost:12000"
echo "📚 الوثائق: http://localhost:12000/docs"
```

---

## 📊 المرحلة الثالثة: المراقبة والتحسين المستمر

### 9.1 نظام المراقبة المتقدم

**إعداد Prometheus و Grafana:**
```yaml
# monitoring/docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources

volumes:
  prometheus_data:
  grafana_data:
```

### 9.2 خطة الصيانة والتحديث

**جدولة المهام الدورية:**
```python
# backend/
